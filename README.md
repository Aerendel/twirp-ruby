# Twirp-Ruby

[Twirp is a protocol]([Twirp protocol](https://twitchtv.github.io/twirp/docs/spec_v5.html)) that specifies how routing and serialization works for services defined in a Protobuf file, so it is easy to implement RPC servers that have auto-generated clients in different languages.

The [first implementation is in Golang](https://github.com/twitchtv/twirp). Twirp-Ruby allows to define Twirp services and clients in Ruby.

## Install

Add `gem "twirp"` to your Gemfile, or install with `gem install twirp`.


## Documentation

[Refer to the Wiki](https://github.com/twitchtv/twirp-ruby/wiki).


## Usage Example

The generated code makes use of the service DSL. For example, the generated code for the `HelloWorld` service looks like this:

Define the service using the DSL. This can be [auto-generated from a .proto file](https://github.com/twitchtv/twirp-ruby/wiki/Code-Generation).

```ruby
module Example
  class HelloWorldService < Twirp::Service
    package "example"
    service "HelloWorld"
    rpc :Hello, HelloRequest, HelloResponse, :ruby_method => :hello
  end

  class HelloWorldClient < Twirp::Client
    client_for HelloWorldService
  end
end
```

The `HelloRequest` and `HelloResponse` messages are expected to be [google-protobuf](https://github.com/google/protobuf/tree/master/ruby) messages. They are generated by `protoc`, but could also be defined from their DSL.


Implement the service with a [Handler](https://github.com/twitchtv/twirp-ruby/wiki/Service-Handlers), that is just a plain object implementing each rpc method. For example a handler for `HelloWorldService`:

```ruby
class HelloWorldHandler

  def hello(req, env)
    if req.name.empty?
      return Twirp::Error.invalid_argument("is mandatory", argument: "name")
    end

    {message: "Hello #{req.name}"}
  end

end
```

Start the service in `http://localhost:3000/twirp:


```ruby
require 'rack'

handler = HelloWorldHandler.new()
service = Example::HelloWorldService.new(handler)

path_prefix = "/twirp/" + service.full_name
server = WEBrick::HTTPServer.new(Port: 3000)
server.mount path_prefix, Rack::Handler::WEBrick, service
server.start
```

Talk to your service using Protobuf from the [client](https://github.com/twitchtv/twirp-ruby/wiki/Twirp-Clients):

```ruby
client = Example::HelloWorldClient.new("http://localhost:3000/twirp")
resp = client.hello(name: "World")
if resp.error
  puts resp.error # <Twirp::Error code:... msg:"..." meta:{...}>
else
  puts resp.data  # <Example::HelloResponse: message:"Hello World">
end
```

Or debug using JSON from `curl`:

```sh
curl --request POST \
  --url http://localhost:3000/example.HelloWorld/Hello \
  --header 'Content-Type: application/json' \
  --data '{"name": "World"}'
```

You can also auto-generate clients in other languages like Golang, JavaScript, Python, Rust, etc. (see [Twirp Golang for more info](https://github.com/twitchtv/twirp)).
